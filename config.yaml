# TradingBot Configuration
# ========================

# Trading mode: "paper" (simulated) or "live" (real money)
trading_mode: paper

# Strategies to enable
strategies:
  credit_spreads:
    enabled: true
    # "bull_put", "bear_call", or "both"
    direction: both
    # Days to expiration range
    min_dte: 20
    max_dte: 45
    # Target delta for short leg
    short_delta: 0.30
    # Width of spread in strikes
    spread_width: 5
    # Minimum credit to collect as % of spread width
    min_credit_pct: 0.30
    # Close at this % of max profit
    profit_target_pct: 0.50
    # Close at this % loss of credit received
    stop_loss_pct: 2.0

  iron_condors:
    enabled: false
    min_dte: 25
    max_dte: 50
    # Target delta for short legs
    short_delta: 0.16
    spread_width: 5
    min_credit_pct: 0.30
    profit_target_pct: 0.50
    stop_loss_pct: 2.0

  covered_calls:
    enabled: false
    min_dte: 20
    max_dte: 45
    # Target delta for calls sold
    short_delta: 0.30
    # Only sell calls on these tickers (must own shares)
    tickers: []

  naked_puts:
    enabled: false
    min_dte: 25
    max_dte: 45
    short_delta: 0.22
    profit_target_pct: 0.50
    exit_dte: 21

  calendar_spreads:
    enabled: false
    front_min_dte: 20
    front_max_dte: 30
    back_min_dte: 50
    back_max_dte: 60
    profit_target_pct: 0.25
    exit_dte: 7

  strangles:
    enabled: false
    min_iv_rank: 70.0
    short_delta: 0.16
    min_account_balance: 25000.0
    allow_straddles_on: ["SPY", "QQQ", "IWM"]
    min_dte: 20
    max_dte: 45
    profit_target_pct: 0.50
    stop_loss_multiple: 2.0

  broken_wing_butterfly:
    enabled: false
    min_dte: 20
    max_dte: 45
    short_delta: 0.30
    near_wing_width: 5.0
    far_wing_width: 10.0
    min_credit: 0.10

  earnings_vol_crush:
    enabled: false
    min_dte: 1
    max_dte: 3
    max_position_risk_pct: 0.5
    min_iv_rank: 75.0
    wing_width: 10.0
    earnings_moves_file: bot/data/earnings_moves.json

# Market Scanner — dynamically finds the best stocks for options trading
# When enabled, the bot scans 150+ tickers across all sectors and ranks them
# by options volume, implied volatility, bid-ask tightness, and liquidity.
# It then trades only the top-ranked tickers each cycle.
scanner:
  enabled: true
  # How many top tickers to trade from scan results
  max_scan_results: 20
  # Cache results for 30 minutes (avoid redundant API calls)
  cache_seconds: 1800
  # Only consider stocks in this price range
  min_price: 10
  max_price: 0  # 0 = no upper limit
  # Minimum daily volume for the underlying stock
  min_underlying_volume: 500000
  # Pull trending movers from Schwab to add to the scan universe
  include_movers: true
  # Pause between ticker API calls to reduce rate-limit pressure
  request_pause_seconds: 0.10
  # Retry/backoff controls for transient quote/chain failures
  error_backoff_seconds: 1.0
  max_retry_attempts: 2
  max_consecutive_errors: 20
  # Optional cap on number of symbols scanned each cycle (0 = disabled)
  max_symbols_per_scan: 0
  # Never trade these symbols even if ranked highly
  blacklist: []
  # Ranking component weights
  movers_weight: 0.15
  sector_rotation_weight: 0.15
  relative_strength_weight: 0.20
  options_liquidity_weight: 0.15

# Fallback watchlist — only used if scanner is disabled
watchlist:
  - SPY
  - QQQ
  - IWM
  - AAPL
  - MSFT
  - AMZN
  - GOOGL
  - META
  - NVDA
  - TSLA

# Risk management
risk:
  # Max % of account value at risk across all positions
  max_portfolio_risk_pct: 5.0
  # Max % of account in a single position
  max_position_risk_pct: 2.0
  # Max number of open positions
  max_open_positions: 10
  # Max number of positions per underlying
  max_positions_per_symbol: 2
  # Min account balance to keep trading
  min_account_balance: 5000
  # Max daily loss before stopping (% of account)
  max_daily_loss_pct: 3.0
  # Proxy downside risk used for covered-call risk budgeting
  covered_call_notional_risk_pct: 20.0
  # Max absolute net portfolio delta
  max_portfolio_delta_abs: 50.0
  # Max absolute net portfolio vega as % of account value
  max_portfolio_vega_pct_of_account: 0.5
  # Max share of total deployed risk in one GICS sector
  max_sector_risk_pct: 40.0
  # Correlation guard lookback and threshold
  correlation_lookback_days: 60
  correlation_threshold: 0.8
  # Portfolio-level average correlation guard
  max_portfolio_correlation: 0.85
  # Parametric VaR guardrails (disabled by default)
  var_enabled: false
  var_lookback_days: 60
  var_limit_pct_95: 3.0
  var_limit_pct_99: 5.0
  correlated_loss_threshold: 3
  correlated_loss_pct: 0.50
  correlated_loss_cooldown_hours: 2
  gamma_week_tight_stop: 1.5
  expiration_day_close_pct: 0.03

risk_profiles:
  conservative:
    max_portfolio_risk_pct: 3.0
    max_position_risk_pct: 1.0
    max_open_positions: 5
    max_daily_loss_pct: 2.0
  moderate:
    max_portfolio_risk_pct: 5.0
    max_position_risk_pct: 2.0
    max_open_positions: 10
    max_daily_loss_pct: 3.0
  aggressive:
    max_portfolio_risk_pct: 8.0
    max_position_risk_pct: 3.0
    max_open_positions: 15
    max_daily_loss_pct: 5.0

sizing:
  method: fixed   # fixed | kelly
  kelly_fraction: 0.5
  kelly_min_trades: 30
  drawdown_decay_threshold: 0.05
  equity_curve_scaling: true
  equity_curve_lookback: 20
  max_scale_up: 1.25
  max_scale_down: 0.50

strategy_allocation:
  enabled: true
  lookback_trades: 30
  min_sharpe_for_boost: 1.5
  cold_start_penalty: 0.75
  cold_start_window_days: 60
  cold_start_min_trades: 10

greeks_budget:
  enabled: true
  reduce_size_to_fit: true
  limits:
    BULL_TREND:
      delta_min: -50.0
      delta_max: 80.0
      vega_min: -200.0
      vega_max: 100.0
    BEAR_TREND:
      delta_min: -80.0
      delta_max: 30.0
      vega_min: -100.0
      vega_max: 200.0
    HIGH_VOL_CHOP:
      delta_min: -30.0
      delta_max: 30.0
      vega_min: -300.0
      vega_max: -50.0
    LOW_VOL_GRIND:
      delta_min: -40.0
      delta_max: 60.0
      vega_min: -150.0
      vega_max: 50.0
    CRASH/CRISIS:
      delta_min: -20.0
      delta_max: 10.0
      vega_min: 0.0
      vega_max: 500.0
    NORMAL:
      delta_min: -50.0
      delta_max: 50.0
      vega_min: -200.0
      vega_max: 200.0

regime:
  enabled: false
  min_confidence: 0.55
  uncertain_size_scalar: 0.80
  cache_seconds: 1800
  history_file: bot/data/regime_history.json

vol_surface:
  enabled: false
  require_positive_vol_risk_premium: true
  max_vol_of_vol_for_condors: 0.20

econ_calendar:
  enabled: false
  refresh_days: 1
  cache_file: bot/data/econ_calendar.json
  high_severity_policy: reduce_size
  medium_severity_policy: widen
  low_severity_policy: none

options_flow:
  enabled: false
  unusual_volume_multiple: 5.0
  include_in_llm_context: true

rolling:
  enabled: false
  min_dte_trigger: 7
  min_credit_for_roll: 0.15
  max_rolls_per_position: 2
  allow_defensive_rolls: true

exits:
  adaptive_targets: true
  trailing_stop_enabled: false
  trailing_stop_activation_pct: 0.25
  trailing_stop_floor_pct: 0.10

adjustments:
  enabled: false
  delta_test_threshold: 0.50
  min_dte_remaining: 7
  max_adjustments_per_position: 2

hedging:
  enabled: false
  delta_hedge_trigger: 50.0
  tail_risk_enabled: false
  max_hedge_cost_pct: 1.0
  auto_execute: false

llm_strategist:
  enabled: false
  provider: google
  model: gemini-2.5-pro
  timeout_seconds: 20
  max_directives: 3

circuit_breakers:
  strategy_loss_streak_limit: 5
  strategy_cooldown_hours: 24
  symbol_loss_streak_limit: 2
  symbol_blacklist_days: 7
  portfolio_drawdown_halt_pct: 5.0
  portfolio_halt_hours: 48
  api_error_rate_threshold: 0.30
  api_window_minutes: 10
  llm_timeout_streak: 3

degradation:
  enabled: true
  fallback_watchlist_on_scanner_failure: true
  fallback_polling_on_stream_failure: true
  continue_on_strategy_errors: true
  rule_only_on_llm_failures: true

# Scheduling
schedule:
  # Market scan times (Eastern Time, 24h format)
  scan_times:
    - "09:45"
    - "11:00"
    - "14:00"
  # Position check interval in minutes
  position_check_interval: 15
  # Only trade on weekdays
  trading_days:
    - monday
    - tuesday
    - wednesday
    - thursday
    - friday

# Live execution controls
execution:
  # Cancel stale working/queued live orders after this many minutes
  cancel_stale_orders: true
  stale_order_minutes: 20
  # Capture partial-fill quantities/prices into live ledger state
  include_partials_in_ledger: true
  # Track partially filled ladder outcomes as live partial positions
  partial_fill_handling: true
  # Cancel/re-evaluate working entries when underlying moves this much (%)
  market_move_cancel_pct: 1.0
  # Avoid poor execution windows for entries (exits are exempt)
  block_first_minutes: 15
  block_last_minutes: 10
  # Smart execution ladder controls
  entry_step_timeout_seconds: 45
  exit_step_timeout_seconds: 60
  max_ladder_attempts: 4
  smart_ladder_enabled: true
  ladder_width_fractions: [0.0, 0.10, 0.25, 0.40]
  ladder_step_timeouts_seconds: [45, 45, 45, 30]
  entry_ladder_shifts: [0.0, 0.25, 0.50]
  exit_ladder_shifts: [0.0, 0.25, 0.50]

# Signal ranking + per-symbol signal fanout control
signal_ranking:
  enabled: true
  weight_score: 0.30
  weight_pop: 0.25
  weight_credit: 0.10
  weight_vol_premium: 0.10
  ml_score_weight: 0.25
  top_ranked_to_log: 5
max_signals_per_symbol_per_strategy: 2

ml_scorer:
  enabled: true
  min_training_trades: 30
  retrain_day: sunday
  retrain_time: "18:00"
  feature_importance_log: true
  closed_trades_file: bot/data/closed_trades.json
  model_file: bot/data/ml_model.json
  feature_importance_file: bot/data/ml_feature_importance.json

theta_harvest:
  enabled: true
  satisfied_pct: 0.80
  underperform_pct: 0.30
  cutoff_hour: 14

correlation_monitor:
  enabled: true
  lookback_days: 20
  crisis_threshold: 0.95
  stress_threshold: 0.85

execution_timing:
  adaptive: true
  min_fills_per_bucket: 20
  analysis_file: bot/data/execution_timing_analysis.json

scaling:
  enabled: false
  scale_in_delay_minutes: 60
  scale_in_max_adds: 2
  partial_exit_pct: 0.40
  partial_exit_size: 0.50

walkforward:
  enabled: false
  train_days: 60
  test_days: 20
  step_days: 20

monte_carlo:
  enabled: true
  simulations: 10000
  var_limit_pct: 3.0

reconciliation:
  interval_minutes: 30
  auto_import: true

multi_timeframe:
  enabled: true
  min_agreement: 2

cooldown:
  graduated: true
  level_1_losses: 2
  level_1_reduction: 0.25
  level_2_losses: 3
  level_2_reduction: 0.50

# Optional LLM advisor
# Use provider "ollama" for local models on your Mac, or "google" for cloud.
llm:
  enabled: true
  provider: google
  model: gemini-2.5-pro
  base_url: http://127.0.0.1:11434
  mode: advisory   # advisory | blocking
  risk_style: moderate   # conservative | moderate | aggressive
  timeout_seconds: 20
  temperature: 0.1
  min_confidence: 0.55
  track_record_file: bot/data/llm_track_record.json
  reasoning_effort: high
  text_verbosity: low
  max_output_tokens: 500
  chat_fallback_model: gemini-2.5-flash
  ensemble_enabled: false
  ensemble_models:
    - google:gemini-2.5-pro
    - google:gemini-2.5-flash
  ensemble_agreement_threshold: 0.66
  multi_turn_enabled: true
  multi_turn_confidence_threshold: 70
  adversarial_review_enabled: true
  adversarial_loss_threshold_pct: 0.50
  journal_enabled: false
  journal_file: bot/data/trade_journal.json
  journal_context_entries: 20
  explanations_file: bot/data/trade_explanations.json

# News intelligence layer
# Pulls stock-specific and market-level headlines and includes them in LLM review context.
news:
  enabled: true
  provider: google_rss
  cache_seconds: 900
  request_timeout_seconds: 10
  max_symbol_headlines: 8
  max_market_headlines: 15
  include_symbol_news: true
  include_market_news: true
  finnhub_api_key: ""
  llm_sentiment_enabled: true
  llm_sentiment_cache_seconds: 1800
  llm_model: gemini-2.5-pro
  llm_reasoning_effort: medium
  llm_text_verbosity: low
  llm_max_output_tokens: 400
  llm_chat_fallback_model: gemini-2.5-flash
  market_queries:
    - "stock market"
    - "federal reserve interest rates"
    - "inflation report"
    - "earnings season"
    - "options market volatility"

# Optional multi-account configuration
# First matching account hash is selected, and risk_profile maps into risk_profiles above.
#schwab:
#  accounts:
#    - name: aggressive
#      hash: abc123
#      risk_profile: aggressive
#    - name: conservative
#      hash: def456
#      risk_profile: conservative

# Optional alerting webhook (Slack/Teams/Discord-compatible JSON webhook)
alerts:
  enabled: false
  webhook_url: ""
  min_level: ERROR
  timeout_seconds: 5
  require_in_live: true
  trade_notifications: false
  daily_summary: false
  regime_changes: false
  weekly_summary: false
  drawdown_thresholds: [1.0, 2.0, 3.0]
  webhook_format: generic  # generic | slack | discord

terminal_ui:
  enabled: true
  refresh_rate: 0.5
  max_activity_events: 50
  show_rejected_trades: true
  compact_mode: false

# Logging
logging:
  level: INFO
  file: logs/tradingbot.log
  max_bytes: 10485760
  backup_count: 5
